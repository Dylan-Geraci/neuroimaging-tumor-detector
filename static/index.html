<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brain Tumor Classification</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Source+Serif+4:opsz,wght@8..60,400;8..60,600;8..60,700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css?v=2">
</head>
<body>
    <div id="toastContainer" class="toast-container"></div>
    <div class="container">
        <!-- Health Banner -->
        <div id="healthBanner" class="health-banner hidden">
            <span class="health-banner-message" id="healthBannerMessage"></span>
            <button class="health-banner-close" onclick="dismissHealthBanner()">&times;</button>
        </div>

        <!-- Header -->
        <header>
            <h1>Brain Tumor Classifier</h1>
            <p class="subtitle">Upload MRI scans for AI-assisted classification</p>
        </header>

        <!-- Main Content -->
        <main>
            <!-- Upload Section -->
            <section class="upload-section" id="uploadSection">
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon-circle" aria-hidden="true">+</div>
                    <h2>Upload MRI Scans</h2>
                    <p>Drag and drop images here, or click to select</p>
                    <p class="file-info">Supported formats: JPG, PNG | Hold Cmd and click to select multiple files</p>
                    <input type="file" id="fileInput" accept="image/*" multiple hidden>
                </div>

                <!-- File Preview Section -->
                <div class="file-preview" id="filePreview">
                    <div class="file-preview-header">
                        <h3>Selected Files: <span id="fileCount">0</span></h3>
                        <button class="add-more-btn" id="addMoreBtn">+ Add More</button>
                    </div>
                    <div class="file-list" id="fileList"></div>
                    <div class="file-actions">
                        <button class="clear-btn" id="clearBtn">Clear Selection</button>
                        <button class="upload-btn" id="uploadBtn">Analyze Scans</button>
                    </div>
                </div>

                <div class="loading" id="loading">
                    <!-- Phase 1: Upload progress -->
                    <div class="upload-progress" id="uploadProgress">
                        <p class="loading-text" id="uploadText">Uploading scan...</p>
                        <div class="progress-bar-track">
                            <div class="progress-bar-fill" id="progressBarFill"></div>
                        </div>
                        <p class="progress-percent" id="progressPercent">0%</p>
                    </div>
                    <!-- Phase 2: Analysis spinner -->
                    <div class="analysis-spinner" id="analysisSpinner">
                        <div class="spinner"><span></span><span></span><span></span></div>
                        <p class="loading-text" id="analysisText">Analyzing scan...</p>
                    </div>
                </div>
            </section>

            <!-- Results Section -->
            <section class="results-section" id="resultsSection">
                <!-- Aggregated Prediction Box -->
                <div class="prediction-box" id="aggregatedPrediction">
                    <h2>Aggregated Diagnosis</h2>
                    <div class="prediction-result">
                        <div class="prediction-class" id="predictionClass">-</div>
                        <div class="confidence" id="confidence">-</div>
                    </div>
                    <div class="batch-info" id="batchInfo">
                        <span class="scan-count" id="scanCount"></span>
                        <span class="agreement-indicator" id="agreementIndicator"></span>
                    </div>
                </div>

                <!-- Aggregated Probabilities -->
                <div class="probabilities">
                    <h3>Aggregated Class Probabilities</h3>
                    <div class="probability-bars" id="probabilityBars">
                        <!-- Dynamically populated -->
                    </div>
                </div>

                <!-- Export Section -->
                <div class="export-section" id="exportSection">
                    <button class="export-btn" id="exportCSV">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14 2 14 8 20 8"/>
                            <line x1="16" y1="13" x2="8" y2="13"/>
                            <line x1="16" y1="17" x2="8" y2="17"/>
                        </svg>
                        Export CSV
                    </button>
                    <button class="export-btn" id="exportPDF">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14 2 14 8 20 8"/>
                            <line x1="12" y1="18" x2="12" y2="12"/>
                            <polyline points="9 15 12 18 15 15"/>
                        </svg>
                        Export PDF
                    </button>
                </div>

                <!-- Individual Scans Section -->
                <div class="individual-scans" id="individualScans">
                    <button class="expand-btn" id="expandBtn">
                        <span>View Individual Scans</span>
                        <svg class="expand-icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </button>
                    <div class="scans-container" id="scansContainer">
                        <!-- Dynamically populated -->
                    </div>
                </div>

                <!-- Single Scan Visualizations (for single file upload) -->
                <div class="visualizations" id="singleVisualizations">
                    <div class="viz-item">
                        <h3>Original MRI</h3>
                        <img id="originalImage" alt="Original MRI" />
                    </div>
                    <div class="viz-item">
                        <h3>Attention Heatmap</h3>
                        <img id="heatmapImage" alt="Grad-CAM Heatmap" />
                    </div>
                    <div class="viz-item">
                        <h3>Overlay</h3>
                        <img id="overlayImage" alt="Overlay" />
                    </div>
                </div>

                <!-- Reset Button -->
                <button class="reset-btn" id="resetBtn">Start Over</button>
                <p class="reset-hint">Upload new scans for classification</p>
            </section>
        </main>

        <!-- Footer -->
        <footer>
            <p class="model-info">ResNet18 model &middot; 97.10% test accuracy</p>
            <p class="disclaimer">This tool is not intended for clinical diagnosis.</p>
        </footer>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="app.js?v=2"></script>
</body>
</html>
